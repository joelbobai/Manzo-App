In the result page where the cards are, when you click on that button, book now, it opens a button sheet. Now, the button sheet has a button which says proceed to book. I think I proceed to book.Now while you click the button, proceed to book now, what I want is that it should take you to a passenger page. So, this later flight data will be taken to that page also and the payloads. Now, let me send you a web version of how I want it to work. I'm sending the code. I'm not saying that it should work exactly, but I just want you to understand how that entire page is going to work by just looking at the code and you should know what to do and how the page should look like, but not do it exactly as it is in the code. ,""use client";

import {
  Suspense,
  useEffect,
  useMemo,
  useState,
  type ChangeEvent,
  type FormEvent,
} from "react";
import CryptoJS from "crypto-js";
import Link from "next/link";
import { useRouter, useSearchParams } from "next/navigation";
import type { FlightOffer, PassengerCounts } from "@/types/flight";
import { useFlightSearchStore } from "@/store/flightSearchStore";
import { useMultiCitySearchStore } from "@/store/multiCitySearchStore";
import { useBookingStore } from "@/store/bookingStore";
import type { PassengerSummary } from "@/store/bookingStore";
import { EXTRA_SERVICE_OPTIONS } from "@/data/addOns";
import { COUNTRY_CALLING_CODES } from "@/data/callingCodes";
import DatePicker from "@/components/DatePicker";

const PASSENGER_TITLES = ["Mr", "Mrs", "Ms", "Miss", "Master", "Dr"] as const;
const GENDER_OPTIONS = ["Male", "Female", "Other"] as const;

type PassengerType = "adult" | "child" | "infant";

type PassengerFormState = {
  id: string;
  label: string;
  type: PassengerType;
  gender: string;
  title: string;
  firstName: string;
  middleName?: string; // made optional
  lastName: string;
  passportNumber: string;
  phoneCountryCode: string;
  phoneNumber: string;
  dateOfBirth: string;
  email: string;
};

// Inside AgreementsSection component, add isLoading prop
type AgreementsSectionProps = {
  agreements: AgreementsState;
  onToggle: (field: keyof AgreementsState) => void;
  isContinueDisabled: boolean;
  status: "idle" | "submitted" | "error";
  isLoading: boolean; // Add this prop
};

type PassengerField = Exclude<
  keyof PassengerFormState,
  "id" | "label" | "type"
>;

type TravelerSummary = {
  type: string;
  label: string;
  count: number;
  total: number;
};

function createPassengerState(
  type: PassengerType,
  index: number
): PassengerFormState {
  const labelMap: Record<PassengerType, string> = {
    adult: "Adult",
    child: "Child",
    infant: "Infant",
  };

  return {
    id: `${type}-${index + 1}`,
    label: `${labelMap[type]} ${index + 1}`,
    type,
    gender: "",
    title: "",
    firstName: "",
    middleName: "",
    lastName: "",
    passportNumber: "",
    phoneCountryCode: "",
    phoneNumber: "",
    dateOfBirth: "",
    email: "",
  };
}

function buildPassengerForms(
  counts?: PassengerCounts | null
): PassengerFormState[] {
  const safeCounts = counts ?? { adults: 1, children: 0, infants: 0 };
  const forms: PassengerFormState[] = [];

  for (let i = 0; i < (safeCounts.adults ?? 0); i += 1) {
    forms.push(createPassengerState("adult", i));
  }

  for (let i = 0; i < (safeCounts.children ?? 0); i += 1) {
    forms.push(createPassengerState("child", i));
  }

  for (let i = 0; i < (safeCounts.infants ?? 0); i += 1) {
    forms.push(createPassengerState("infant", i));
  }

  if (forms.length === 0) {
    forms.push(createPassengerState("adult", 0));
  }

  return forms;
}

function formatDateHeading(dateString?: string | null) {
  if (!dateString) return "";

  const date = new Date(dateString);
  if (Number.isNaN(date.getTime())) return "";

  return date.toLocaleDateString("en-US", {
    weekday: "short",
    month: "short",
    day: "numeric",
  });
}

function formatTravelerLabel(type: string): string {
  const normalized = type.toLowerCase();

  if (normalized === "adult" || normalized === "adt") {
    return "Adult";
  }

  if (normalized === "child" || normalized === "chd") {
    return "Child";
  }

  if (normalized === "infant" || normalized === "inf") {
    return "Infant";
  }

  return type.charAt(0).toUpperCase() + type.slice(1).toLowerCase();
}

function summarizeTravelerPricing(
  travelerPricings: FlightOffer["travelerPricings"] | undefined
): TravelerSummary[] {
  if (!travelerPricings?.length) {
    return [];
  }

  const summary = new Map<string, TravelerSummary>();

  travelerPricings.forEach((pricing) => {
    const key = pricing.travelerType?.toUpperCase() ?? "TRAVELER";
    const amount = Number(pricing.price.total ?? 0) + 20000;
    const previous = summary.get(key) ?? {
      type: key,
      label: formatTravelerLabel(key),
      count: 0,
      total: 0,
    };

    summary.set(key, {
      ...previous,
      count: previous.count + 1,
      total: previous.total + (Number.isFinite(amount) ? amount : 0),
    });
  });

  return Array.from(summary.values());
}

function StepIndicator() {
  const steps: Array<{
    id: number;
    label: string;
    status: "complete" | "current" | "upcoming";
  }> = [
    { id: 1, label: "Flight Selection", status: "complete" },
    { id: 2, label: "Passenger & Extras_Services", status: "current" },
    { id: 3, label: "Overview & Payment", status: "upcoming" },
  ];

  return (
    <nav aria-label="Booking progress" className="w-full">
      <ol className="flex flex-col gap-3 text-xs sm:flex-row sm:flex-wrap sm:items-center">
        {steps.map((step, index) => {
          const isLast = index === steps.length - 1;

          const colorStyles =
            step.status === "complete"
              ? "border-orange-200 bg-white text-slate-700"
              : step.status === "current"
              ? "border-orange-500 bg-orange-50 text-orange-600"
              : "border-slate-200 bg-white text-slate-400";

          const badgeStyles =
            step.status === "complete"
              ? "border-orange-200 bg-orange-50 text-orange-500"
              : step.status === "current"
              ? "border-orange-500 bg-orange-500 text-white"
              : "border-slate-200 bg-slate-100 text-slate-400";

          return (
            <li
              key={step.id}
              className="flex w-full min-w-0 flex-col gap-3 sm:w-auto sm:flex-row sm:items-center"
            >
              <span
                className={`flex min-w-0 flex-1 items-center gap-3 rounded-full border px-4 py-2 text-sm font-medium transition ${colorStyles} sm:flex-none`}
              >
                <span
                  className={`flex h-8 w-8 shrink-0 items-center justify-center rounded-full border text-xs font-semibold ${badgeStyles}`}
                >
                  {step.id}
                </span>
                <span className="min-w-0 text-left text-sm font-semibold text-inherit">
                  {step.label}
                </span>
              </span>
              {!isLast ? (
                <span
                  className="hidden h-px w-12 bg-gradient-to-r from-orange-400/80 via-orange-200/40 to-transparent md:block"
                  aria-hidden
                />
              ) : null}
            </li>
          );
        })}
      </ol>
    </nav>
  );
}

type PassengerFormProps = {
  passenger: PassengerFormState;
  index: number;
  onChange: (id: string, field: PassengerField, value: string) => void;
};

function PassengerForm({ passenger, index, onChange }: PassengerFormProps) {
  const baseInputStyles =
    "w-full rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-900 placeholder:text-slate-400 focus:border-orange-500 focus:outline-none focus:ring-2 focus:ring-orange-200";
  const inputStyles = `mt-2 ${baseInputStyles}`;

  const handleChange =
    (field: PassengerField) =>
    (
      event: ChangeEvent<
        HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement
      >
    ) => {
      onChange(passenger.id, field, event.target.value);
    };

  const passengerTypeLabel =
    passenger.type.charAt(0).toUpperCase() + passenger.type.slice(1);

  return (
    <section className="rounded-3xl border border-slate-200 bg-white p-6 shadow-[0_18px_40px_rgba(15,23,42,0.08)]">
      <header className="flex flex-col gap-3 border-b border-slate-100 pb-4 sm:flex-row sm:flex-wrap sm:items-center sm:justify-between">
        <div>
          <p className="text-xs uppercase tracking-[0.35em] text-orange-500">
            Selected passenger {index + 1}
          </p>
          <h3 className="mt-2 text-xl font-semibold text-slate-900">
            {passenger.label}
          </h3>
        </div>
        <span className="self-start rounded-full border border-orange-200 bg-orange-50 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-orange-600 sm:self-auto">
          {passengerTypeLabel}
        </span>
      </header>
      <div className="mt-6 grid gap-4 md:grid-cols-2">
        <label className="block">
          <span className="sr-only">Gender</span>
          <select
            value={passenger.gender}
            onChange={handleChange("gender")}
            className={`${inputStyles} appearance-none`}
            required
          >
            <option value="" disabled>
              Select Gender
            </option>
            {GENDER_OPTIONS.map((option) => (
              <option key={option} value={option}>
                {option}
              </option>
            ))}
          </select>
        </label>
        <label className="block">
          <span className="sr-only">Title</span>
          <select
            value={passenger.title}
            onChange={handleChange("title")}
            className={`${inputStyles} appearance-none`}
            required
          >
            <option value="" disabled>
              Select Title
            </option>
            {PASSENGER_TITLES.map((title) => (
              <option key={title} value={title}>
                {title}
              </option>
            ))}
          </select>
        </label>
        <label className="block">
          <span className="sr-only">First name</span>
          <input
            type="text"
            value={passenger.firstName}
            onChange={handleChange("firstName")}
            className={inputStyles}
            placeholder="Enter Your First Name"
            required
          />
        </label>
        <label className="block">
          <span className="sr-only">Middle name</span>
          <input
            type="text"
            value={passenger.middleName}
            onChange={handleChange("middleName")}
            className={inputStyles}
            placeholder="Enter Your Middle Name"
          />
        </label>
        <label className="block">
          <span className="sr-only">Last name</span>
          <input
            type="text"
            value={passenger.lastName}
            onChange={handleChange("lastName")}
            className={inputStyles}
            placeholder="Enter Your Last Name"
            required
          />
        </label>
        <label className="block">
          <span className="sr-only">Passport number</span>
          <input
            type="text"
            value={passenger.passportNumber}
            onChange={handleChange("passportNumber")}
            className={inputStyles}
            placeholder="Passport Number"
            required
          />
        </label>
        <label className="block">
          <span className="sr-only">Phone number</span>

          <div className="mt-2 flex flex-col overflow-hidden rounded-2xl border border-slate-300 bg-white text-sm shadow-sm focus-within:border-orange-500 focus-within:ring-2 focus-within:ring-orange-100 sm:flex-row">
            <div className="relative w-full border-b border-slate-200 bg-slate-50 sm:w-40 sm:border-b-0 sm:border-r">
              <select
                value={passenger.phoneCountryCode}
                onChange={handleChange("phoneCountryCode")}
                className="h-full w-full appearance-none bg-transparent py-3 pl-4 pr-10 font-medium text-slate-900 focus:outline-none"
                required
              >
                <option value="" disabled>
                  üåê Code
                </option>
                {COUNTRY_CALLING_CODES.map((item) => (
                  <option
                    key={`${item.country}-${item.code}`}
                    value={item.code}
                  >
                    {`${item.flag} ${item.code}`}
                  </option>
                ))}
              </select>
              <span className="pointer-events-none absolute inset-y-0 right-3 flex items-center text-slate-400">
                <svg
                  aria-hidden="true"
                  className="h-4 w-4"
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 20 20"
                  fill="currentColor"
                >
                  <path
                    fillRule="evenodd"
                    d="M5.23 7.21a.75.75 0 011.06.02L10 10.585l3.71-3.354a.75.75 0 111.02 1.1l-4.219 3.814a.75.75 0 01-1.02 0L5.25 8.33a.75.75 0 01-.02-1.12z"
                    clipRule="evenodd"
                  />
                </svg>
              </span>
            </div>
            <input
              type="tel"
              value={passenger.phoneNumber}
              onChange={handleChange("phoneNumber")}
              className="flex-1 border-0 bg-transparent px-4 py-3 text-slate-900 placeholder:text-slate-400 focus:outline-none"
              placeholder="(123) 456-7890"
              required
            />
          </div>
        </label>

        <label className="block">
          <span className="sr-only">Date of birth</span>
          <DatePicker
            value={passenger.dateOfBirth}
            onChange={(nextValue) =>
              onChange(passenger.id, "dateOfBirth", nextValue)
            }
            placeholder="Date of Birth"
            className="mt-2"
            inputClassName={baseInputStyles}
            ariaLabel="Date of birth"
            name={`${passenger.id}-dob`}
            disableFutureDates
          />
        </label>
        <label className="block md:col-span-2">
          <span className="sr-only">Email address</span>
          <input
            type="email"
            value={passenger.email}
            onChange={handleChange("email")}
            className={inputStyles}
            placeholder="Enter Your Email Address"
            required
          />
        </label>
      </div>
    </section>
  );
}

type AddOnsSectionProps = {
  selectedExtras: Set<string>;
  onToggle: (id: string) => void;
};

function AddOnsSection({ selectedExtras, onToggle }: AddOnsSectionProps) {
  return (
    <section className="rounded-3xl border border-slate-200 bg-white p-6 shadow-[0_18px_40px_rgba(15,23,42,0.08)]">
      <header>
        <h3 className="text-lg font-semibold text-slate-900">Add-Ons</h3>
        <p className="mt-1 text-sm text-slate-500">
          Customize and safe flight.
        </p>
      </header>
      <div className="mt-6 grid gap-4 sm:grid-cols-2">
        {EXTRA_SERVICE_OPTIONS.map((extra) => {
          const isSelected = selectedExtras.has(extra.id);

          return (
            <button
              key={extra.id}
              type="button"
              onClick={() => onToggle(extra.id)}
              className={`group rounded-2xl border px-4 py-5 text-left transition ${
                isSelected
                  ? "border-orange-400 bg-orange-50 text-orange-600 shadow-sm"
                  : "border-slate-200 bg-white text-slate-600 hover:border-orange-200 hover:bg-orange-50/40 hover:text-slate-900"
              }`}
            >
              <div className="flex items-start justify-between gap-4">
                <div className="space-y-2">
                  <p className="text-sm font-semibold text-slate-900">
                    {extra.label}
                  </p>
                  <p className="text-xs text-slate-500">{extra.description}</p>
                </div>
                <span
                  className={`flex h-8 w-8 items-center justify-center rounded-full border text-sm font-semibold transition ${
                    isSelected
                      ? "border-orange-400 bg-orange-100 text-orange-600"
                      : "border-slate-200 text-slate-400"
                  }`}
                  aria-hidden
                >
                  {isSelected ? "‚úì" : "+"}
                </span>
              </div>
            </button>
          );
        })}
      </div>
    </section>
  );
}

function normalizeGender(gender?: string) {
  if (!gender) {
    return "UNSPECIFIED";
  }

  const normalized = gender.trim().toLowerCase();

  if (!normalized) {
    return "UNSPECIFIED";
  }

  if (normalized === "male" || normalized === "m") {
    return "MALE";
  }

  if (normalized === "female" || normalized === "f") {
    return "FEMALE";
  }

  if (normalized === "other" || normalized === "o") {
    return "OTHER";
  }

  return normalized.toUpperCase();
}
function parsePhoneNumber(phone?: string | null) {
  if (!phone) {
    return null;
  }

  const trimmed = phone.trim();

  if (!trimmed) {
    return null;
  }

  const digits = trimmed.replace(/\D+/g, "");

  if (!digits) {
    return null;
  }

  if (trimmed.startsWith("+") && digits.length > 4) {
    const possibleLengths = [3, 2, 1] as const;

    for (const length of possibleLengths) {
      if (digits.length - length >= 4) {
        return {
          countryCallingCode: digits.slice(0, length),
          number: digits.slice(length),
        };
      }
    }
  }

  return {
    countryCallingCode: "",
    number: digits,
  };
}

type AgreementsState = {
  terms: boolean;
  accuracy: boolean;
};

// type AgreementsSectionProps = {
//   agreements: AgreementsState;
//   onToggle: (field: keyof AgreementsState) => void;
//   isContinueDisabled: boolean;
//   status: "idle" | "submitted" | "error";
//   isLoading: boolean; // Add this prop
// };
type TicketingPassengerPhone = {
  deviceType: "MOBILE";
  countryCallingCode: string;
  number: string;
};

type TicketingPassengerContact = {
  emailAddress: string;
  phones: TicketingPassengerPhone[];
};
type TicketingPassenger = {
  id: string;
  dateOfBirth: string | null;
  name: {
    firstName: string;
    middleName?: string; // optional here too
    lastName: string;
  };
  gender: string;
  contact: TicketingPassengerContact;
};
function deriveNameParts(passenger: PassengerSummary) {
  const explicitFirst = passenger.firstName?.trim();
  const explicitLast = passenger.lastName?.trim();

  if (explicitFirst || explicitLast) {
    return {
      firstName: explicitFirst ?? "",
      lastName: explicitLast ?? "",
    };
  }

  const tokens = passenger.fullName
    ?.split(/\s+/)
    .map((token) => token.trim())
    .filter(Boolean);

  if (tokens && tokens.length > 0) {
    const [firstToken, ...rest] = tokens;
    return {
      firstName: firstToken,
      lastName: rest.join(" "),
    };
  }

  return {
    firstName: passenger.label,
    lastName: "",
  };
}

function formatPassengersForTicketing(
  passengers: PassengerSummary[]
): TicketingPassenger[] {
  return passengers.map((passenger, index) => {
    const nameParts = deriveNameParts(passenger);
    const phoneDetails = parsePhoneNumber(passenger.phoneNumber);
    const emailAddress = passenger.email?.trim() ?? "";

    // Ensure middleName is explicitly preserved (trimmed) or undefined if empty
    const middle = passenger.middleName?.trim();
    const middleName = middle && middle.length > 0 ? middle : undefined;

    // Ensure firstName is always a string
    const firstName = (
      nameParts.firstName || 
      passenger.label || 
      `Passenger ${index + 1}`
    ).trim();

    // Add middleName to firstName if it exists
    const finalFirstName = middleName 
      ? `${firstName} ${middleName}`
      : firstName;

    return {
      id: `${index + 1}`,
      dateOfBirth: passenger.dateOfBirth?.trim() || null,
      name: {
        firstName: finalFirstName,
        lastName: (
          nameParts.lastName ||
          passenger.lastName?.trim() ||
          nameParts.firstName ||
          passenger.label ||
          `Passenger ${index + 1}`
        ).trim(),
      },
      gender: normalizeGender(passenger.gender),
      contact: {
        emailAddress,
        phones: phoneDetails
          ? [
              {
                deviceType: "MOBILE",
                countryCallingCode: phoneDetails.countryCallingCode,
                number: phoneDetails.number,
              },
            ]
          : [],
      },
    };
  });
}

function AgreementsSection({
  agreements,
  onToggle,
  isContinueDisabled,
  status,
  isLoading, // added isLoading here so the component can use the prop passed from the parent
}: AgreementsSectionProps) {
  const checkboxStyles =
    "mt-1 h-5 w-5 shrink-0 rounded border border-slate-300 bg-white accent-orange-500";

  const buttonStyles = isContinueDisabled
    ? "bg-slate-200 text-slate-500 cursor-not-allowed"
    : "relative overflow-hidden bg-gradient-to-r from-orange-500 to-amber-400 text-white shadow-[0_10px_40px_rgba(249,115,22,0.35)] transition-all duration-300 ease-in-out hover:from-amber-400 hover:to-orange-500 hover:shadow-[0_15px_45px_rgba(249,115,22,0.55)] hover:scale-105 active:scale-95 focus:ring-4 focus:ring-orange-200";

  return (
    <section className="rounded-3xl border border-slate-200 bg-white p-6 shadow-[0_18px_40px_rgba(15,23,42,0.08)]">
      <div className="space-y-4 text-sm text-slate-600">
        <label className="flex items-start gap-3">
          <input
            type="checkbox"
            checked={agreements.terms}
            onChange={() => onToggle("terms")}
            className={checkboxStyles}
          />
          <span>
            I have read and agree to the{" "}
            <Link
              href="/terms-and-conditions"
               target="_blank" 
               rel="noopener noreferrer"
              className="font-semibold text-orange-500 hover:text-orange-400"
            >
              Terms & Conditions
            </Link>
            .
          </span>
        </label>
        <label className="flex items-start gap-3">
          <input
            type="checkbox"
            checked={agreements.accuracy}
            onChange={() => onToggle("accuracy")}
            className={checkboxStyles}
          />
          <span>
            I confirm that the passenger details provided are correct and match
            the travelers‚Äô identification documents.
          </span>
        </label>
      </div>

      <div className="mt-6 flex flex-col gap-4 text-sm text-slate-500 sm:flex-row sm:items-center sm:justify-between">
        <p>Ensure all traveler names are entered exactly as they appear.</p>
        <button
          type="submit"
          disabled={isContinueDisabled || isLoading}
          className={`inline-flex items-center justify-center gap-2 rounded-full px-8 py-3 text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-orange-200 focus:ring-offset-2 focus:ring-offset-[#f5f7fb] ${buttonStyles}`}
          aria-disabled={isContinueDisabled || isLoading}
        >
          {isLoading ? (
            <>
              <svg
                className="animate-spin -ml-1 mr-3 h-5 w-5 text-white"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
              >
                <circle
                  className="opacity-25"
                  cx="12"
                  cy="12"
                  r="10"
                  stroke="currentColor"
                  strokeWidth="4"
                />
                <path
                  className="opacity-75"
                  fill="currentColor"
                  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                />
              </svg>
              Processing...
            </>
          ) : (
            <>
              <span className="relative z-10">Continue</span>
              <span aria-hidden>‚Üí</span>
              {!isContinueDisabled && (
                <span className="absolute inset-0 rounded-full bg-orange-400 opacity-0 blur-lg transition-opacity duration-500 hover:opacity-30 animate-pulse" />
              )}
            </>
          )}
        </button>
      </div>
      {status === "submitted" ? (
        <p className="mt-4 text-sm text-emerald-600">
          Passenger details saved! Continue to payment to finalize your booking.
        </p>
      ) : null}
      {status === "error" ? (
        <p className="mt-4 text-sm text-rose-500">
          Please complete all required fields and agree to the terms before
          continuing.
        </p>
      ) : null}
    </section>
  );
}

type BookingSummaryProps = {
  offer: FlightOffer;
  currency: string;
  passengerSummaryLabel: string;
  passengerChipList: string[];
  departureDateLabel: string;
  selectedExtraLabels: string[];
  travelerSummary: TravelerSummary[];
  originCode?: string;
  destinationCode?: string;
  travelClass?: string;
};

function BookingSummary({
  offer,
  currency,
  passengerSummaryLabel,
  passengerChipList,
  departureDateLabel,
  selectedExtraLabels,
  travelerSummary,
  originCode,
  destinationCode,
  travelClass,
}: BookingSummaryProps) {
  const formatter = useMemo(
    () =>
      new Intl.NumberFormat("en-US", {
        style: "currency",
        currency,
      }),
    [currency]
  );

  const totalAmount = Number(
    offer.price.grandTotal ?? offer.price.total ?? offer.price.base ?? 0
  );

  return (
    <section className="rounded-3xl border border-slate-200 bg-white p-6 shadow-[0_18px_40px_rgba(15,23,42,0.08)]">
      <header className="flex flex-col gap-4">
        <div className="flex flex-col gap-3 sm:flex-row sm:flex-wrap sm:items-center sm:justify-between">
          <h2 className="text-lg font-semibold text-slate-900">
            Booking Summary
          </h2>
          <span className="self-start rounded-full border border-orange-200 bg-orange-50 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-orange-600 sm:self-auto">
            {passengerSummaryLabel}
          </span>
        </div>
        <div className="flex flex-wrap gap-2">
          {passengerChipList.map((chip) => (
            <span
              key={chip}
              className="rounded-full bg-slate-100 px-3 py-1 text-xs font-medium text-slate-600"
            >
              {chip}
            </span>
          ))}
        </div>
      </header>

      <div className="mt-6 space-y-3 text-sm text-slate-500">
        {originCode && destinationCode ? (
          <div className="flex items-center justify-between gap-3">
            <span>Route</span>
            <span className="font-semibold text-slate-900">
              {originCode} ‚Üí {destinationCode}
            </span>
          </div>
        ) : null}
        {departureDateLabel ? (
          <div className="flex items-center justify-between gap-3">
            <span>Departure</span>

            <span className="font-medium text-slate-900">
              {departureDateLabel}
            </span>
          </div>
        ) : null}
        {travelClass ? (
          <div className="flex items-center justify-between gap-3">
            <span>Cabin</span>

            <span className="font-medium text-slate-900">{travelClass}</span>
          </div>
        ) : null}
      </div>
      {travelerSummary.length ? (
        <div className="mt-6 space-y-3 rounded-2xl border border-slate-100 bg-slate-50 p-4 text-sm text-slate-600">
          {travelerSummary.map((traveler) => (
            <div
              key={traveler.type}
              className="flex items-center justify-between gap-3"
            >
              <span>
                {traveler.count} {traveler.label}
                {traveler.count > 1 ? "s" : ""}
              </span>

              <span className="font-semibold text-slate-900">
                {formatter.format(traveler.total)}
              </span>
            </div>
          ))}
        </div>
      ) : null}
      {selectedExtraLabels.length ? (
        <div className="mt-6 space-y-2">
          <p className="text-xs uppercase tracking-wide text-slate-500">
            Add-ons
          </p>
          <ul className="space-y-2 text-sm text-slate-600">
            {selectedExtraLabels.map((label) => (
              <li key={label} className="flex items-center gap-2">
                <span className="inline-flex h-5 w-5 items-center justify-center rounded-full bg-orange-100 text-xs font-semibold text-orange-500">
                  +
                </span>
                <span>{label}</span>
              </li>
            ))}
          </ul>
        </div>
      ) : null}

      <div className="mt-8 rounded-2xl bg-gradient-to-r from-orange-100 via-transparent to-transparent p-5">
        <span className="text-xs uppercase tracking-wide text-slate-500">
          Total Price
        </span>
        <p className="mt-3 text-3xl font-semibold text-slate-900">
          {formatter.format(Number.isFinite(totalAmount) ? totalAmount + 20000 : 0) }
        </p>
        <p className="mt-1 text-xs text-slate-500">
          Taxes and fees are included in the displayed amount.
        </p>
      </div>
    </section>
  );
}

function NoFlightSelected() {
  return (
    <div className="rounded-3xl border border-dashed border-slate-200 bg-white p-12 text-center text-slate-900 shadow-[0_18px_40px_rgba(15,23,42,0.08)]">
      <h2 className="text-2xl font-semibold">No flight selected</h2>
      <p className="mt-3 text-sm text-slate-600">
        Choose a flight from the search results to continue to passenger
        details.
      </p>
      <div className="mt-6 flex flex-wrap items-center justify-center gap-3">
        <Link
          href="/results"
          className="rounded-full bg-gradient-to-r from-orange-500 to-amber-400 px-5 py-2.5 text-sm font-semibold text-white shadow-[0_10px_40px_rgba(249,115,22,0.35)]"
        >
          Back to flight results
        </Link>
        <Link
          href="/"
          className="rounded-full border border-slate-200 px-5 py-2.5 text-sm font-semibold text-slate-600 transition hover:border-orange-300 hover:text-slate-900"
        >
          Start a new search
        </Link>
      </div>
    </div>
  );
}

function PassengerDetailsPageContent() {
  const [isLoading, setIsLoading] = useState(false);
  const searchParams = useSearchParams();
  const router = useRouter();
  const requestedOfferId = searchParams.get("offerId");
  const {
    results: standardResults,
    payload: standardPayload,
    currency,
  } = useFlightSearchStore();
  const { results: multiResults, payload: multiPayload } =
    useMultiCitySearchStore();
  const isMultiCitySearch = useMemo(
    () =>
      (standardPayload?.flightSearch ?? []).some(
        (segment) => Boolean(segment.from) && Boolean(segment.to)
      ),
    [standardPayload]
  );
  const activeResults = useMemo(
    () => (isMultiCitySearch ? multiResults : standardResults),
    [isMultiCitySearch, multiResults, standardResults]
  );
  const activePayload = useMemo(
    () =>
      isMultiCitySearch ? multiPayload ?? standardPayload : standardPayload,
    [isMultiCitySearch, multiPayload, standardPayload]
  );
  const { selectedExtras: storedExtras, setBookingDetails } = useBookingStore(
    (state) => ({
      selectedExtras: state.selectedExtras,
      setBookingDetails: state.setBookingDetails,
    })
  );
  const [passengers, setPassengers] = useState<PassengerFormState[]>(() =>
    buildPassengerForms(activePayload?.passenger)
  );
  const [selectedExtras, setSelectedExtras] = useState<Set<string>>(
    () => new Set(storedExtras)
  );
  const [agreements, setAgreements] = useState<AgreementsState>({
    terms: false,
    accuracy: false,
  });
  const [formStatus, setFormStatus] = useState<"idle" | "submitted" | "error">(
    "idle"
  );

  useEffect(() => {
    setPassengers(buildPassengerForms(activePayload?.passenger));
  }, [activePayload?.passenger]);

  const selectedOffer = useMemo(() => {
    const offers = activeResults?.flightRights ?? [];

    if (!offers.length) {
      return null;
    }

    if (requestedOfferId) {
      const found = offers.find((offer) => offer.id === requestedOfferId);

      if (found) {
        return found;
      }
    }

    return offers[0] ?? null;
  }, [activeResults?.flightRights, requestedOfferId]);

  const activeDictionaries = useMemo(
    () => activeResults?.flightRightsDictionaries,
    [activeResults]
  );

  const travelerSummary = useMemo(
    () => summarizeTravelerPricing(selectedOffer?.travelerPricings),
    [selectedOffer?.travelerPricings]
  );

  const passengerChipList = useMemo(() => {
    const counts = activePayload?.passenger;
    if (!counts) {
      return ["1 Adult"];
    }

    const chips: string[] = [];

    if (counts.adults) {
      chips.push(`${counts.adults} Adult${counts.adults > 1 ? "s" : ""}`);
    }
    if (counts.children) {
      chips.push(`${counts.children} Child${counts.children > 1 ? "ren" : ""}`);
    }
    if (counts.infants) {
      chips.push(`${counts.infants} Infant${counts.infants > 1 ? "s" : ""}`);
    }

    return chips.length ? chips : ["1 Adult"];
  }, [activePayload?.passenger]);

  const passengerSummaryLabel = passengerChipList.join(" ‚Ä¢ ");

  const primaryItinerary = selectedOffer?.itineraries[0];
  const originCode = primaryItinerary?.segments[0]?.departure.iataCode;
  const destinationCode =
    primaryItinerary?.segments[primaryItinerary.segments.length - 1]?.arrival
      .iataCode;

  const departureDateLabel = formatDateHeading(
    primaryItinerary?.segments[0]?.departure.at
  );

  const selectedExtraLabels = useMemo(
    () =>
      EXTRA_SERVICE_OPTIONS.filter((extra) => selectedExtras.has(extra.id)).map(
        (extra) => extra.label
      ),
    [selectedExtras]
  );

  const dictionaries = activeDictionaries;

  const arePhoneNumbersComplete = passengers.every(
    (passenger) =>
      passenger.phoneCountryCode.trim().length > 0 &&
      passenger.phoneNumber.trim().length > 0
  );

  const isContinueDisabled =
    !agreements.terms || !agreements.accuracy || !arePhoneNumbersComplete;

  const handlePassengerChange = (
    id: string,
    field: PassengerField,
    value: string
  ) => {
    setPassengers((prev) =>
      prev.map((passenger) =>
        passenger.id === id ? { ...passenger, [field]: value } : passenger
      )
    );
    setFormStatus("idle");
  };

  const handleToggleExtra = (id: string) => {
    setSelectedExtras((prev) => {
      const next = new Set(prev);
      if (next.has(id)) {
        next.delete(id);
      } else {
        next.add(id);
      }
      return next;
    });
    setFormStatus("idle");
  };

  const handleAgreementToggle = (field: keyof AgreementsState) => {
    console.log('Toggling agreement:', field);
    console.log('Previous state:', agreements);
    
    setAgreements((prev) => {
      const newState = { ...prev, [field]: !prev[field] };
      console.log('New state:', newState);
      return newState;
    });
    setFormStatus("idle");
  };

  const handleSubmit = async (event: FormEvent<HTMLFormElement>) => {
    event.preventDefault();

    if (!selectedOffer) {
      return;
    }

    if (isContinueDisabled) {
      setFormStatus("error");
      return;
    }
     setIsLoading(true);
    setFormStatus("submitted");

    const passengerSummaries = passengers.map((passenger) => {
      const fullName = [
        passenger.title,
        passenger.firstName,
        passenger.middleName,
        passenger.lastName,
      ]
        .filter((part) => part && part.trim().length > 0)
        .join(" ")
        .trim();

      return {
        id: passenger.id,
        label: passenger.label,
        type: passenger.type,
        fullName: fullName || passenger.label,
        email: passenger.email,
        phoneNumber: [passenger.phoneCountryCode, passenger.phoneNumber]
          .filter((part) => part.trim().length > 0)
          .join(" ")
          .trim(),
        title: passenger.title,
        firstName: passenger.firstName,
        // explicitly include trimmed middleName or undefined when empty
        middleName: passenger.middleName?.trim() || undefined,
        lastName: passenger.lastName,
        gender: passenger.gender,
        dateOfBirth: passenger.dateOfBirth,
        passportNumber: passenger.passportNumber,
      };
    });

    setBookingDetails({
      selectedOfferId: selectedOffer.id ?? null,
      passengers: passengerSummaries,
      selectedExtras: Array.from(selectedExtras),
    });

    try {
      const ticketPayload = {
        flight: selectedOffer,
        travelers: formatPassengersForTicketing(passengerSummaries),
        littelFlightInfo: [
          {
            dictionaries,
          },
        ],
      };

      // debug: confirm middle names are present (remove in production)
      console.log("ticketPayload (pre-encrypt):", JSON.stringify(ticketPayload, null, 2));

      const secretKey = process.env.NEXT_PUBLIC_SECRET_KEY;

      if (!secretKey) {
        throw new Error(
          "Ticket issuance secret key is not configured. Please set NEXT_PUBLIC_SECRET_KEY."
        );
      }

      const hash = CryptoJS.AES.encrypt(
        JSON.stringify(ticketPayload),
        secretKey
      ).toString();

       const response = await fetch(
      "https://manzo-be.onrender.com/api/v1/flights/reserveTicket",
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ hashedData: hash }),
      }
    );

    if (!response.ok) {
      const errorBody = await response.text();
      throw new Error(
        errorBody || "Ticket issuance failed after payment confirmation."
      );
    }

    const data = await response.json();
    const offerId = selectedOffer.id;
    const nextUrl = offerId
      ? `/overviewAndpayment?offerId=${encodeURIComponent(
          offerId
        )}&reservedId=${encodeURIComponent(data.reservedId)}`
      : "/overviewAndpayment";

    router.push(nextUrl);
    } catch (error) {
      console.error("Unable to initialize Paystack", error);
       setFormStatus("error");
    }finally {
    setIsLoading(false);
  }
  };

  return (
    <main className="min-h-screen w-full bg-[#f5f7fb] px-4 py-10 text-slate-900 sm:px-6 lg:px-8">
      <div className="mx-auto w-full max-w-6xl space-y-10">
        <div className="flex flex-col gap-4 md:flex-row md:flex-wrap md:items-center md:justify-between">
          <StepIndicator />
          <span className="w-full max-w-full rounded-full border border-orange-200 bg-orange-50 px-4 py-2 text-center text-sm font-semibold text-orange-600 md:w-auto md:text-left">
            {passengerSummaryLabel}
          </span>
        </div>
        {!selectedOffer ? (
          <NoFlightSelected />
        ) : (
          <div className="grid gap-10 lg:grid-cols-[minmax(0,2fr)_minmax(0,1fr)] lg:items-start">
            <form onSubmit={handleSubmit} className="space-y-8 min-w-0">
              {passengers.map((passenger, index) => (
                <PassengerForm
                  key={passenger.id}
                  passenger={passenger}
                  index={index}
                  onChange={handlePassengerChange}
                />
              ))}

              <AddOnsSection
                selectedExtras={selectedExtras}
                onToggle={handleToggleExtra}
              />

              <AgreementsSection
                agreements={agreements}
                onToggle={handleAgreementToggle}
                isContinueDisabled={isContinueDisabled}
                status={formStatus}
                isLoading={isLoading}
              />
            </form>
            <aside className="space-y-6 min-w-0">
              <BookingSummary
                offer={selectedOffer}
                currency={currency}
                passengerSummaryLabel={passengerSummaryLabel}
                passengerChipList={passengerChipList}
                departureDateLabel={departureDateLabel}
                selectedExtraLabels={selectedExtraLabels}
                travelerSummary={travelerSummary}
                originCode={originCode}
                destinationCode={destinationCode}
                travelClass={activePayload?.passenger?.travelClass}
              />
            </aside>
          </div>
        )}
      </div>
    </main>
  );
}

export default function PassengerDetailsPage() {
  return (
    <Suspense
      fallback={
        <div className="flex min-h-screen items-center justify-center bg-slate-50 px-4 py-10 text-slate-900">
          <p className="text-sm text-slate-600">Loading passenger form‚Ä¶</p>
        </div>
      }
    >
      <PassengerDetailsPageContent />
    </Suspense>
  );
}
"